#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]:-$0}")" >/dev/null 2>&1 && pwd)"

usage() {
  cat >&2 <<'USAGE'
Usage:
  hgene -v <virus> [-c <cpu>] <fastqPrefix>

Arguments:
  -v <virus>       Virus reference key (e.g. HHV1, HHV2, HHV5)
  -c <cpu>         Threads (default: nproc)
  <fastqPrefix>    Prefix without extension (expects <prefix>.fastq)

USAGE
  exit 2
}

timestamp() { date "+%Y-%m-%d %H:%M:%S"; }
log() { local level="$1"; shift; echo "[$(timestamp)] [$level] $*"; }
info() { log "INFO" "$*"; }
step() { log "STEP" "$*"; }
warn() { log "WARN" "$*"; }
error() { log "ERROR" "$*"; }

die() { error "$*"; exit 1; }

# -------------------- args --------------------
virus=""
CPU="$(nproc)"

while getopts ":hv:c:" opt; do
  case "$opt" in
    h) usage ;;
    v) virus="$OPTARG" ;;
    c) CPU="$OPTARG" ;;
    \?) die "Unknown option: -$OPTARG (use -h)" ;;
    :) die "Option -$OPTARG requires an argument" ;;
  esac
done
shift $((OPTIND-1))

prefix="${1:-}"
[[ -n "$prefix" ]] || usage
[[ -n "$virus" ]] || die "Missing -v <virus> (use -h)"

# -------------------- global log (stdout+stderr) --------------------
LOG="${prefix}.log"
exec > >(tee -a "$LOG") 2>&1

info "hgene started"
info "prefix=$prefix virus=$virus cpu=$CPU"

# Singularity context
if [[ -n "${SINGULARITY_CONTAINER:-}" ]]; then
  info "Singularity container: ${SINGULARITY_CONTAINER}"
  if command -v sha256sum >/dev/null 2>&1 && [[ -r "${SINGULARITY_CONTAINER}" ]]; then
    info "Container SHA256: $(sha256sum "${SINGULARITY_CONTAINER}" | awk '{print $1}')"
  fi
fi

# Sanity check input
[[ -s "${prefix}.fastq" ]] || die "Input FASTQ not found: ${prefix}.fastq"

step "Running hgene_main.sh"
"${SCRIPT_DIR}/hgene_main.sh" "$prefix" "$CPU" "$virus"

info "hgene finished"